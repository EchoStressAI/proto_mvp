<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Запись видео</title>
  
</head>
<body>
  <h1>Видео-диалог</h1>
  
  <div>
    <h2>Вопрос</h2>
    <audio id="questionAudio" controls></audio>
    <br>
    <!-- Кнопка для загрузки вопроса -->
    <button id="loadQuestion">Загрузить вопрос</button>
    <!-- Новая кнопка для проверки наличия вопроса -->
    <button id="checkQuestion">Есть вопрос?</button>
    <!-- Кнопка подтверждения вопроса (удаления) -->
    <button id="ackQuestion">Подтвердить вопрос</button>
  </div>

  <div>
    <h2>Ваш ответ</h2>
    <video id="preview" autoplay muted></video>
    <video id="recorded" controls></video>
    <div>
      <button id="startRecording">Начать запись</button>
      <button id="stopRecording" disabled>Остановить запись</button>
      <button id="uploadAnswer" disabled>Отправить ответ</button>
    </div>
  </div>

  <script>
    const questionAudio = document.getElementById('questionAudio');
    const loadQuestionBtn = document.getElementById('loadQuestion');
    const checkQuestionBtn = document.getElementById('checkQuestion');
    const ackQuestionBtn = document.getElementById('ackQuestion');

    const previewVideo = document.getElementById('preview');
    const recordedVideo = document.getElementById('recorded');
    const startRecordingBtn = document.getElementById('startRecording');
    const stopRecordingBtn = document.getElementById('stopRecording');
    const uploadAnswerBtn = document.getElementById('uploadAnswer');

    let mediaRecorder;
    let recordedChunks = [];
    let cameraStream;

    // Загрузить аудиовопрос с сервера
    loadQuestionBtn.addEventListener('click', async () => {
      const response = await fetch('/get_question');
      if (response.ok) {
        const audioBlob = await response.blob();
        questionAudio.src = URL.createObjectURL(audioBlob);
        ackQuestionBtn.disabled = false;
      } else {
        alert('Ошибка загрузки аудиовопроса или вопросов нет');
        questionAudio.src = "";
        ackQuestionBtn.disabled = true;
      }
    });

    // Проверить наличие вопроса
    checkQuestionBtn.addEventListener('click', async () => {
      // Выполняем запрос на получение вопроса без загрузки в аудио
      const response = await fetch('/check_question');
      if (response.ok) {
        alert('Вопрос найден!');
      } else {
        alert('Вопросов нет!');
      }
    });

    // Подтвердить (ack) вопрос после его обработки с проверкой наличия
    ackQuestionBtn.addEventListener('click', async () => {
      if (!questionAudio.src) {
        alert('Вопрос не загружен. Пожалуйста, загрузите вопрос.');
        return;
      }
      const response = await fetch('/ack_question', { method: 'POST' });
      if (response.ok) {
        alert('Вопрос подтвержден и удалён из очереди');
        questionAudio.src = "";
        ackQuestionBtn.disabled = true;
      } else {
        alert('Ошибка подтверждения вопроса');
      }
    });

    // Начать запись
    startRecordingBtn.addEventListener('click', async () => {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        previewVideo.srcObject = cameraStream;
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(cameraStream, { mimeType: 'video/mp4' });
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        mediaRecorder.start();
        startRecordingBtn.disabled = true;
        stopRecordingBtn.disabled = false;
        uploadAnswerBtn.disabled = true;
      } catch (error) {
        console.error('Ошибка доступа к камере или микрофону:', error);
        alert('Ошибка доступа к камере или микрофону. Проверьте настройки.');
      }
    });

    // Остановить запись
    stopRecordingBtn.addEventListener('click', () => {
      mediaRecorder.stop();
      mediaRecorder.onstop = () => {
        const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
        recordedVideo.src = URL.createObjectURL(videoBlob);
        previewVideo.srcObject = null;
        cameraStream.getTracks().forEach((track) => track.stop());
        stopRecordingBtn.disabled = true;
        uploadAnswerBtn.disabled = false;
      };
    });

    // Отправить видео на сервер
    uploadAnswerBtn.addEventListener('click', async () => {
      const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
      const formData = new FormData();
      formData.append('video', videoBlob, 'answer.webm');
      const response = await fetch('/upload_answer', { method: 'POST', body: formData });
      if (response.ok) {
        alert('Видео успешно отправлено!');
      } else {
        alert('Ошибка отправки видео');
      }
    });
  </script>
</body>
</html>
