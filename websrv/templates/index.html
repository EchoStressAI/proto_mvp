<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel='stylesheet' type='text/css' />
  <title>Видео-диалог</title>
  <style>
    /* Центрирование GIF */
    #idleGif, #questionGif, #speakingGif {
      display: block;
      margin: 0 auto 10px;
      max-width: 100%;
    }
    /* Скрыть аудио-проигрыватель */
    #questionAudio {
      display: none;
    }
  </style>
</head>
<body class="index">
  <div class="container">
    <header class="main_header">
      <img class="logo" alt="EchoStressAI" src="{{ url_for('static', filename='images/logo.png') }}">
      <a href="/logout" class="btn btn-primary btn-login">Выйти</a>
    </header>
    <div class="site-container">
      <h1>
        <a class="back_link" href="javascript:history.go(-1)"><img src="{{ url_for('static', filename='images/icon_back.svg') }}"></a> Видео-диалог
      </h1>

      <div class="site-container_block">
        <h2>Вопрос</h2>
        <!-- GIF для разных состояний -->
        <img id="idleGif" src="{{ url_for('static', filename='images/idle.gif') }}" alt="Ожидание вопроса" style="display:none;">
        <img id="questionGif" src="{{ url_for('static', filename='images/question.gif') }}" alt="Загрузка вопроса..." style="display:none;">
        <img id="speakingGif" src="{{ url_for('static', filename='images/ActiveListening.gif') }}" alt="Пользователь отвечает" style="display:none;">
        <audio id="questionAudio"></audio>
        <div id="ackQuestionResponce"></div>
      </div>

      <div class="site-container_block">
        <h2>Ваш ответ</h2>
        <div>
          <button class="main-button" id="toggleRecording">Начать запись</button>
        </div>
      </div>

      <script>
        const idleGif = document.getElementById('idleGif');
        const questionGif = document.getElementById('questionGif');
        const speakingGif = document.getElementById('speakingGif');
        const questionAudio = document.getElementById('questionAudio');
        const toggleRecordingBtn = document.getElementById('toggleRecording');

        let mediaRecorder;
        let recordedChunks = [];
        let cameraStream;
        let isRecording = false;

        // По окончании аудио вопроса возвращаем idle GIF
        questionAudio.addEventListener('ended', () => {
          questionGif.style.display = 'none';
          idleGif.style.display = 'block';
        });

        // Проверка вопроса при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
          idleGif.style.display = 'block';
          try {
            const resp = await fetch('/check_question');
            if (resp.ok) {
              const getQ = await fetch('/get_question');
              if (getQ.ok) {
                const audioBlob = await getQ.blob();
                questionAudio.src = URL.createObjectURL(audioBlob);
              }
            }
          } catch (e) {
            console.error('Ошибка при проверке вопроса:', e);
          }
        });

        // Таймер для новых вопросов
        async function checkAndPlayQuestion() {
          try {
            const resp = await fetch('/check_question');
            if (resp.ok) {
              const getQ = await fetch('/get_question');
              if (getQ.ok) {
                const audioBlob = await getQ.blob();
                idleGif.style.display = 'none';
                questionGif.style.display = 'block';
                questionAudio.src = URL.createObjectURL(audioBlob);
                questionAudio.play().catch(e => console.warn('Автовоспроизведение заблокировано:', e));
                await fetch('/ack_question', { method: 'POST' });
              }
            }
          } catch (e) {
            console.error('Ошибка при проверке вопроса:', e);
          }
        }
        setInterval(checkAndPlayQuestion, 1000);

        // Кнопка записи
        toggleRecordingBtn.addEventListener('click', async () => {
          if (!isRecording) {
            try {
              cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
              recordedChunks = [];
              mediaRecorder = new MediaRecorder(cameraStream, { mimeType: 'video/mp4' });

              mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
              mediaRecorder.start();
              toggleRecordingBtn.textContent = 'Остановить запись';
              isRecording = true;
              idleGif.style.display = 'none';
              questionGif.style.display = 'none';
              speakingGif.style.display = 'block';
            } catch (e) {
              alert('Ошибка доступа к камере или микрофону. Проверьте настройки.');
            }
          } else {
            mediaRecorder.stop();
            mediaRecorder.onstop = async () => {
              cameraStream.getTracks().forEach(t => t.stop());
              toggleRecordingBtn.textContent = 'Начать запись';
              isRecording = false;
              speakingGif.style.display = 'none';
              idleGif.style.display = 'block';

              const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
              const formData = new FormData();
              formData.append('video', videoBlob, 'answer.webm');
              try {
                await fetch('/upload_answer', { method: 'POST', body: formData });
              } catch (e) {
                console.error('Ошибка при отправке видео:', e);
              }
            };
          }
        });
      </script>
    </div>
  </div>
</body>
</html>
